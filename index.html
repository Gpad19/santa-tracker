<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Santa Tracker - Visited Stops</title>

<script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />

<style>
html, body, #cesiumContainer {
  width: 100%;
  height: 100%;
  margin: 0;
  background: #081a2b;
  overflow: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

#hud {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(0,0,0,0.55);
  color: white;
  padding: 12px 16px;
  border-radius: 10px;
  backdrop-filter: blur(8px);
  font-size: 14px;
  z-index: 10;
}

#title {
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 16px;
}

#snapButton {
  margin-top: 6px;
  padding: 6px 12px;
  background: #ff2d2d;
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: 600;
  cursor: pointer;
}
#snapButton:hover {
  background: #ff5252;
}
</style>
</head>

<body>
<div id="cesiumContainer"></div>

<div id="hud">
  <div id="title">üéÖ Santa Tracker</div>
  <div>Stops: <span id="stops">‚Äî</span></div>
  <div>Visited: <span id="visited">0</span></div>
  <div>Country: <span id="country">‚Äî</span></div>
  <div>City: <span id="city">‚Äî</span></div>
  <button id="snapButton">üìç Snap to Santa</button>
</div>

<script>
Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiZjEyOGQ2Mi1jMGUwLTRhNmMtYThhZi1lYTcyMzAwYWFiMDYiLCJpZCI6MTIxODQ5LCJpYXQiOjE2NzQxNjE4MDh9.-_OgfjufhglZ0BdQkgwdlNqABiJNfe61EzpscAFljBE";

const ROUTE = [
  { country: "New Zealand", cities: [["Auckland",-36.8,174.8],["Wellington",-41.3,174.8]] },
  { country: "Australia", cities: [["Sydney",-33.9,151.2],["Melbourne",-37.8,144.9]] },
  { country: "Japan", cities: [["Tokyo",35.7,139.7],["Osaka",34.7,135.5]] },
  { country: "China", cities: [["Beijing",39.9,116.4],["Shanghai",31.2,121.5]] },
  { country: "India", cities: [["Delhi",28.6,77.2],["Mumbai",19.1,72.9]] },
  { country: "UAE", cities: [["Dubai",25.2,55.3]] },
  { country: "Egypt", cities: [["Cairo",30.0,31.2]] },
  { country: "France", cities: [["Paris",48.9,2.4]] },
  { country: "UK", cities: [["London",51.5,-0.1]] },
  { country: "Canada", cities: [["Toronto",43.7,-79.4],["Vancouver",49.3,-123.1]] },
  { country: "USA", cities: [["New York",40.7,-74.0],["Chicago",41.9,-87.6],["Denver",39.7,-105.0],["Los Angeles",34.0,-118.2]] },
  { country: "Mexico", cities: [["Mexico City",19.4,-99.1]] }
];

const FLIGHT_HEIGHT = 40000;
let stops = []; // array of all city stops
ROUTE.forEach(country => {
  country.cities.forEach(city => {
    stops.push({ country: country.country, name: city[0], lat: city[1], lon: city[2], entity: null });
  });
});

document.getElementById("stops").textContent = stops.length;

(function initCesium() {

  const viewer = new Cesium.Viewer("cesiumContainer", {
    timeline: false,
    animation: false,
    baseLayerPicker: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    fullscreenButton: false,
    navigationHelpButton: false,
    shouldAnimate: true
  });

  viewer.scene.globe.depthTestAgainstTerrain = false;

  // Build Santa's path
  const path = new Cesium.SampledPositionProperty();
  const startTime = Cesium.JulianDate.now();
  const secondsPerStop = 24*60*60 / stops.length; // total 24h divided by real stops

  stops.forEach((stop,i)=>{
    const time = Cesium.JulianDate.addSeconds(startTime,i*secondsPerStop,new Cesium.JulianDate());
    path.addSample(time,Cesium.Cartesian3.fromDegrees(stop.lon,stop.lat,FLIGHT_HEIGHT));
    // Add small gray point for stop
    stop.entity = viewer.entities.add({
      position: Cesium.Cartesian3.fromDegrees(stop.lon, stop.lat, FLIGHT_HEIGHT),
      point: { pixelSize: 5, color: Cesium.Color.DARKGRAY, outlineColor: Cesium.Color.WHITE, outlineWidth: 1 }
    });
  });

  // Santa entity
  const santa = viewer.entities.add({
    position: path,
    point: { pixelSize: 10, color: Cesium.Color.RED, outlineColor: Cesium.Color.WHITE, outlineWidth: 1, disableDepthTestDistance: Number.POSITIVE_INFINITY }
  });

  viewer.clock.startTime = startTime.clone();
  viewer.clock.stopTime = Cesium.JulianDate.addSeconds(startTime,24*60*60,new Cesium.JulianDate());
  viewer.clock.currentTime = startTime.clone();
  viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;
  viewer.clock.multiplier = 1;

  viewer.trackedEntity = santa;

  // Free camera
  const c = viewer.scene.screenSpaceCameraController;
  c.enableRotate = true;
  c.enableZoom = true;
  c.enableTranslate = true;
  c.enableTilt = true;
  c.enableLook = true;

  // Initial camera
  const initialPos = santa.position.getValue(startTime);
  viewer.camera.lookAt(initialPos,new Cesium.Cartesian3(-800000,0,40000));

  // Snap button
  const snapBtn = document.getElementById("snapButton");
  snapBtn.addEventListener("click",()=>{
    const santaPos = santa.position.getValue(viewer.clock.currentTime);
    if(!santaPos) return;
    viewer.camera.flyToBoundingSphere(new Cesium.BoundingSphere(santaPos,40000),{duration:1.5});
  });

  // Cinematic orbit
  let orbitAngle = 0;
  viewer.scene.postRender.addEventListener(()=>{
    if (!viewer.scene.screenSpaceCameraController.inertiaSpin) {
      const time = viewer.clock.currentTime;
      const santaPos = santa.position.getValue(time);
      if (!santaPos) return;
      orbitAngle += 0.001;
      const offset = new Cesium.Cartesian3(
        -800000*Math.cos(orbitAngle),
        -800000*Math.sin(orbitAngle),
        40000
      );
      viewer.camera.lookAt(
        santaPos,
        Cesium.Cartesian3.lerp(viewer.camera.positionWC, offset, 0.03, new Cesium.Cartesian3())
      );
    }
  });

  // =========================
  // Register and mark visited stops
  // =========================
  let visitedStops = new Set();
  viewer.clock.onTick.addEventListener(()=>{
    const time = viewer.clock.currentTime;
    const santaPos = santa.position.getValue(time);

    stops.forEach((stop,index)=>{
      const stopPos = Cesium.Cartesian3.fromDegrees(stop.lon,stop.lat,FLIGHT_HEIGHT);
      if (santaPos && Cesium.Cartesian3.distance(santaPos,stopPos) < 20000) {
        if(!visitedStops.has(index)){
          visitedStops.add(index);
          // Change stop color to green when visited
          stop.entity.point.color = Cesium.Color.LIME;
          stop.entity.point.pixelSize = 7;
        }
      }
    });

    // Update HUD
    const lastVisitedIndex = Math.max(...Array.from(visitedStops),0);
    const lastStop = stops[lastVisitedIndex];
    document.getElementById("visited").textContent = visitedStops.size;
    if(lastStop){
      document.getElementById("country").textContent = lastStop.country;
      document.getElementById("city").textContent = lastStop.name;
    }
  });

})();
</script>
</body>
</html>

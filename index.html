<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Santa Tracker ðŸŽ…</title>

  <!-- iPad / Mobile -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Cesium -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }

    #info {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0, 0, 0, 0.65);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-family: system-ui, -apple-system;
      font-size: 14px;
      z-index: 10;
      min-width: 220px;
    }
  </style>
</head>
<body>

<div id="cesiumContainer"></div>
<div id="info">ðŸŽ… Preparing for departureâ€¦</div>

<script>
  // =====================================
  // ðŸ”‘ Cesium ion Access Token (REQUIRED)
  // =====================================
  Cesium.Ion.defaultAccessToken =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiZjEyOGQ2Mi1jMGUwLTRhNmMtYThhZi1lYTcyMzAwYWFiMDYiLCJpZCI6MTIxODQ5LCJpYXQiOjE2NzQxNjE4MDh9.-_OgfjufhglZ0BdQkgwdlNqABiJNfe61EzpscAFljBE";

  // =====================================
  // ðŸŒ Cesium Viewer
  // =====================================
  const viewer = new Cesium.Viewer("cesiumContainer", {
    animation: false,
    timeline: false,
    baseLayerPicker: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    navigationHelpButton: false,
    fullscreenButton: false,
    infoBox: false,
    selectionIndicator: false,
    shouldAnimate: true
  });

  viewer.scene.globe.enableLighting = true;
  viewer.scene.requestRenderMode = true;
  viewer.scene.maximumRenderTimeChange = Infinity;

  // =====================================
  // â° Santa global time window (UTC)
  // =====================================
  const santaStart = Cesium.JulianDate.fromIso8601("2026-12-24T00:00:00Z");
  const santaEnd   = Cesium.JulianDate.fromIso8601("2026-12-25T00:00:00Z");

  // =====================================
  // ðŸ™ Cities (ordered) + stop duration (sec)
  // =====================================
  const cities = [
    { name: "North Pole", lon: -135, lat: 90, stop: 180 },
    { name: "Anchorage", lon: -149.9, lat: 61.2, stop: 120 },
    { name: "New York", lon: -74.0, lat: 40.7, stop: 120 },
    { name: "London", lon: -0.1, lat: 51.5, stop: 120 },
    { name: "Paris", lon: 2.35, lat: 48.86, stop: 120 },
    { name: "Dubai", lon: 55.27, lat: 25.2, stop: 120 },
    { name: "Mumbai", lon: 72.87, lat: 19.07, stop: 120 },
    { name: "Tokyo", lon: 139.7, lat: 35.7, stop: 120 },
    { name: "Sydney", lon: 151.2, lat: -33.8, stop: 120 }
  ];

  // =====================================
  // ðŸ§® Time calculations
  // =====================================
  const totalSeconds =
    Cesium.JulianDate.secondsDifference(santaEnd, santaStart);

  const totalStopSeconds =
    cities.reduce((sum, c) => sum + c.stop, 0);

  const travelSeconds = totalSeconds - totalStopSeconds;
  const travelPerLeg = travelSeconds / (cities.length - 1);

  // =====================================
  // ðŸ“ Build Santa path (arrive â†’ stop â†’ depart)
  // =====================================
  const position = new Cesium.SampledPositionProperty();
  let currentTime = santaStart.clone();

  cities.forEach((city, index) => {
    // ARRIVAL
    city.arrival = currentTime.clone();
    position.addSample(
      city.arrival,
      Cesium.Cartesian3.fromDegrees(city.lon, city.lat, 300000)
    );

    // STOP (pause)
    currentTime = Cesium.JulianDate.addSeconds(
      currentTime,
      city.stop,
      new Cesium.JulianDate()
    );

    // DEPARTURE (same position, later time)
    city.departure = currentTime.clone();
    position.addSample(
      city.departure,
      Cesium.Cartesian3.fromDegrees(city.lon, city.lat, 300000)
    );

    // TRAVEL to next city
    if (index < cities.length - 1) {
      currentTime = Cesium.JulianDate.addSeconds(
        currentTime,
        travelPerLeg,
        new Cesium.JulianDate()
      );
    }
  });

  // =====================================
  // ðŸŽ… Santa entity
  // =====================================
  const santa = viewer.entities.add({
    availability: new Cesium.TimeIntervalCollection([
      new Cesium.TimeInterval({ start: santaStart, stop: santaEnd })
    ]),
    position,
    orientation: new Cesium.VelocityOrientationProperty(position),
    model: {
      uri: "https://cdn.jsdelivr.net/gh/AnalyticalGraphicsInc/cesium-assets@master/models/CesiumMan/Cesium_Man.glb",
      minimumPixelSize: 64
    },
    path: {
      width: 3,
      material: Cesium.Color.RED
    }
  });

  viewer.trackedEntity = santa;

  // =====================================
  // ðŸ•° Real-time UTC clock sync
  // =====================================
  viewer.clock.startTime = santaStart.clone();
  viewer.clock.stopTime = santaEnd.clone();
  viewer.clock.clockStep = Cesium.ClockStep.SYSTEM_CLOCK;
  viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;

  // =====================================
  // ðŸ“¢ City detection + status display
  // =====================================
  const info = document.getElementById("info");
  let lastState = "";

  viewer.clock.onTick.addEventListener(clock => {
    const now = clock.currentTime;

    // Before departure
    if (Cesium.JulianDate.lessThan(now, santaStart)) {
      if (lastState !== "PREP") {
        lastState = "PREP";
        info.innerHTML = "ðŸŽ… Preparing for departureâ€¦";
      }
      return;
    }

    // After completion
    if (Cesium.JulianDate.greaterThan(now, santaEnd)) {
      if (lastState !== "DONE") {
        lastState = "DONE";
        info.innerHTML = "ðŸŽ„ Santa has completed deliveries!";
      }
      return;
    }

    // City arrival detection
    for (let i = cities.length - 1; i >= 0; i--) {
      if (Cesium.JulianDate.lessThanOrEquals(cities[i].arrival, now)) {
        if (lastState !== cities[i].name) {
          lastState = cities[i].name;
          info.innerHTML =
            `ðŸŽ… Santa is in<br><strong>${cities[i].name}</strong>`;
        }
        break;
      }
    }
  });

  // =====================================
  // ðŸŽ¥ Initial camera
  // =====================================
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(-135, 80, 3_000_000)
  });
</script>

</body>
</html>

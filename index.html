<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Santa Tracker ðŸŽ…</title>

<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet" />

<style>
html, body, #cesiumContainer {
  width: 100%;
  height: 100%;
  margin: 0;
  overflow: hidden;
  background: black;
}

#info {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(0,0,0,0.65);
  color: white;
  padding: 12px 16px;
  border-radius: 10px;
  font-family: system-ui, -apple-system;
  font-size: 14px;
  min-width: 220px;
}
</style>
</head>
<body>

<div id="cesiumContainer"></div>
<div id="info">ðŸŽ… Preparing for departureâ€¦</div>

<script>
/* ================= TOKEN ================= */
Cesium.Ion.defaultAccessToken =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiZjEyOGQ2Mi1jMGUwLTRhNmMtYThhZi1lYTcyMzAwYWFiMDYiLCJpZCI6MTIxODQ5LCJpYXQiOjE2NzQxNjE4MDh9.-_OgfjufhglZ0BdQkgwdlNqABiJNfe61EzpscAFljBE";

/* ================= VIEWER ================= */
const viewer = new Cesium.Viewer("cesiumContainer", {
  animation: false,
  timeline: false,
  baseLayerPicker: false,
  geocoder: false,
  homeButton: false,
  sceneModePicker: false,
  navigationHelpButton: false,
  fullscreenButton: false
});

viewer.scene.globe.enableLighting = true;
viewer.scene.requestRenderMode = true;

/* ================= CITIES ================= */
const cities = [
  { name: "North Pole", lon: -135, lat: 90, stop: 0.05 },
  { name: "Anchorage", lon: -149.9, lat: 61.2, stop: 0.05 },
  { name: "New York", lon: -74.0, lat: 40.7, stop: 0.05 },
  { name: "London", lon: -0.1, lat: 51.5, stop: 0.05 },
  { name: "Paris", lon: 2.35, lat: 48.86, stop: 0.05 },
  { name: "Dubai", lon: 55.27, lat: 25.2, stop: 0.05 },
  { name: "Mumbai", lon: 72.87, lat: 19.07, stop: 0.05 },
  { name: "Tokyo", lon: 139.7, lat: 35.7, stop: 0.05 },
  { name: "Sydney", lon: 151.2, lat: -33.8, stop: 0.05 }
];

/* ================= BUILD FRACTIONAL PATH ================= */
const position = new Cesium.SampledPositionProperty();
let fraction = 0;

cities.forEach((city, i) => {
  city.arrival = fraction;

  position.addSample(
    Cesium.JulianDate.fromIso8601("2020-01-01T00:00:00Z")
      .addSeconds(fraction * 86400),
    Cesium.Cartesian3.fromDegrees(city.lon, city.lat, 300000)
  );

  fraction += city.stop;

  position.addSample(
    Cesium.JulianDate.fromIso8601("2020-01-01T00:00:00Z")
      .addSeconds(fraction * 86400),
    Cesium.Cartesian3.fromDegrees(city.lon, city.lat, 300000)
  );

  if (i < cities.length - 1) {
    fraction += (1 - cities.reduce((s,c)=>s+c.stop,0)) / (cities.length - 1);
  }
});

/* ================= SLEIGH ================= */
const sleigh = viewer.entities.add({
  position,
  orientation: new Cesium.VelocityOrientationProperty(position),
  model: {
    uri: Cesium.IonResource.fromAssetId(229),
    minimumPixelSize: 96
  }
});

viewer.trackedEntity = sleigh;

/* ================= GREAT CIRCLE ARCS ================= */
function arc(a, b) {
  const g = new Cesium.EllipsoidGeodesic(
    Cesium.Cartographic.fromDegrees(a.lon, a.lat),
    Cesium.Cartographic.fromDegrees(b.lon, b.lat)
  );

  const pts = [];
  for (let i = 0; i <= 64; i++) {
    const f = i / 64;
    const c = g.interpolateUsingFraction(f);
    pts.push(
      Cesium.Cartesian3.fromRadians(
        c.longitude, c.latitude,
        300000 + Math.sin(Math.PI * f) * 200000
      )
    );
  }

  viewer.entities.add({
    polyline: {
      positions: pts,
      width: 2,
      material: Cesium.Color.RED
    }
  });
}

for (let i = 0; i < cities.length - 1; i++) {
  arc(cities[i], cities[i+1]);
}

/* ================= CLOCK ================= */
const base = Cesium.JulianDate.fromIso8601("2020-01-01T00:00:00Z");
viewer.clock.startTime = base.clone();
viewer.clock.stopTime = Cesium.JulianDate.addSeconds(base, 86400, new Cesium.JulianDate());
viewer.clock.currentTime = Cesium.JulianDate.addSeconds(
  base,
  (Date.now() % 86400000) / 1000,
  new Cesium.JulianDate()
);
viewer.clock.multiplier = 1;
viewer.clock.shouldAnimate = true;

/* ================= STATUS ================= */
const info = document.getElementById("info");

viewer.clock.onTick.addEventListener(clock => {
  const frac = Cesium.JulianDate.secondsDifference(clock.currentTime, base) / 86400;

  for (let i = cities.length - 1; i >= 0; i--) {
    if (frac >= cities[i].arrival) {
      info.innerHTML = `ðŸŽ… Santa is near<br><strong>${cities[i].name}</strong>`;
      break;
    }
  }
});

/* ================= CAMERA ================= */
viewer.camera.flyTo({
  destination: Cesium.Cartesian3.fromDegrees(-135, 80, 3000000)
});
</script>
</body>
</html>
